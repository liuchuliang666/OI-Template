本页面包含多项式常见的初等函数操作。具体而言，本页面包含如下内容：

1.  多项式求逆
2.  多项式开方
3.  多项式除法
4.  多项式取模
5.  多项式指数函数
6.  多项式对数函数
7.  多项式快速幂
8.  多项式三角函数
9.  多项式反三角函数

??? note "初等函数与非初等函数"
    初等函数的定义如下：

    若域 $F$ 中存在映射 $u\to \partial u$ 满足：

    1.  $\partial(u+v)=\partial u+\partial v$
    2.  $\partial(uv)=u\partial v+v\partial u$

    则称这个域为 **微分域**。

    若微分域 $F$ 上的函数 $u$ 满足以下的任意一条条件，则称该函数 $u$ 为初等函数：

    3.  $u$ 是 $F$ 上的代数函数。
    4.  $u$ 是 $F$ 上的指数性函数，即存在 $a\in F$ 使得 $\partial u=u\partial a$.
    5.  $u$ 是 $F$ 上的对数性函数，即存在 $a\in F$ 使得 $\partial u=\frac{\partial a}{a}$.

    以下是常见的初等函数：

    6.  代数函数：存在有限次多项式 $P$ 使得 $P(f(x))=0$ 的函数 $f(x)$，如 $2x+1$,$\sqrt{x}$,$(1+x^2)^{-1}$,$|x|$.
    7.  指数函数
    8.  对数函数
    9.  三角函数
    10. 反三角函数
    11. 双曲函数
    12. 反双曲函数
    13. 以上函数的复合，如：

        $$
        \frac{\mathrm{e}^{\tan x}}{1+x^2}\sin\left(\sqrt{1+\ln^2 x}\right)
        $$

        $$
        -\mathrm{i} \ln\left(x+\mathrm{i}\sqrt{1-x^2}\right)
        $$

    以下是常见的非初等函数：

    14. 误差函数：

        $$
        \operatorname{erf}(x):=\frac{2}{\sqrt{\pi}}\int_{0}^{x}\exp\left(-t^2\right)\mathrm{d}t
        $$

## 多项式求逆

???+ question "[P4238 【模板】多项式乘法逆](https://www.luogu.com.cn/problem/P4238)"
    给定一个多项式 $F(x)$ ，请求出一个多项式 $G(x)$， 满足 $F(x) * G(x) \equiv 1 \pmod{x^n}$。

    系数对 $998244353$ 取模。

    对于 $100\%$ 的数据，$1 \leq n \leq 10^5$，$0 \leq a_i \leq 10^9$。

首先，易知

$$
\left[x^{0}\right]f^{-1}\left(x\right)=\left(\left[x^{0}\right]f\left(x\right)\right)^{-1}
$$

假设现在已经求出了 $f\left(x\right)$ 在模 $x^{\left\lceil\frac{n}{2}\right\rceil}$ 意义下的逆元 $f^{-1}_{0}\left(x\right)$。
有：

$$
\begin{aligned}
    f\left(x\right)f^{-1}_{0}\left(x\right)&\equiv 1 &\pmod{x^{\left\lceil\frac{n}{2}\right\rceil}}\\
    f\left(x\right)f^{-1}\left(x\right)&\equiv 1 &\pmod{x^{\left\lceil\frac{n}{2}\right\rceil}}\\
    f^{-1}\left(x\right)-f^{-1}_{0}\left(x\right)&\equiv 0 &\pmod{x^{\left\lceil\frac{n}{2}\right\rceil}}
\end{aligned}
$$

两边平方可得：

$$
f^{-2}\left(x\right)-2f^{-1}\left(x\right)f^{-1}_{0}\left(x\right)+f^{-2}_{0}\left(x\right)\equiv 0 \pmod{x^{n}}
$$

两边同乘 $f\left(x\right)$ 并移项可得：

$$
f^{-1}\left(x\right)\equiv f^{-1}_{0}\left(x\right)\left(2-f\left(x\right)f^{-1}_{0}\left(x\right)\right) \pmod{x^{n}}
$$

递归计算即可，初始边界是$\left[x^{0}\right]f^{-1}\left(x\right)=\left(\left[x^{0}\right]f\left(x\right)\right)^{-1}$，不过改成自底而上的迭代会好得多。

**时间复杂度**

$$
T\left(n\right)=T\left(\frac{n}{2}\right)+O\left(n\log{n}\right)=O\left(n\log{n}\right)
$$

??? code "实现（迭代版）"
    ```cpp
    --8<-- "docs/Math/Poly/code/P4238.cpp:41:58"
    ```

## 多项式开方

???+ question "[P5205 【模板】多项式开根](https://www.luogu.com.cn/problem/P5205) [P5277 【模板】多项式开根（加强版）](https://www.luogu.com.cn/problem/P5277)"
    给定多项式 $f\left(x\right)$，求 $g\left(x\right)$，满足：

    $$
    g^{2}\left(x\right)\equiv f\left(x\right) \pmod{x^{n}}
    $$

    普通版保证 $f_0 = 1$，加强版只保证 $f_0$ 有二次剩余。

首先讨论 $\left[x^0\right]f(x)$ 不为 $0$ 的情况。

易知：

$$
\left[x^0\right]g(x) = \sqrt{\left[x^0\right]f(x)}
$$

若 $\left[x^0\right]f(x)$ 没有平方根，则多项式 $f(x)$ 没有平方根。

> $\left[x^0\right]f(x)$ 可能有多个平方根，选取不同的根会求出不同的 $g(x)$。

假设现在已经求出了 $f\left(x\right)$ 在模 $x^{\left\lceil\frac{n}{2}\right\rceil}$ 意义下的平方根 $g_{0}\left(x\right)$，则有：

$$
\begin{aligned}
    g_{0}^{2}\left(x\right)&\equiv f\left(x\right) &\pmod{x^{\left\lceil\frac{n}{2}\right\rceil}}\\
    g_{0}^{2}\left(x\right)-f\left(x\right)&\equiv 0 &\pmod{x^{\left\lceil\frac{n}{2}\right\rceil}}\\
    \left(g_{0}^{2}\left(x\right)-f\left(x\right)\right)^{2}&\equiv 0 &\pmod{x^{n}}\\
    \left(g_{0}^{2}\left(x\right)+f\left(x\right)\right)^{2}&\equiv 4g_{0}^{2}\left(x\right)f\left(x\right) &\pmod{x^{n}}\\
    \left(\frac{g_{0}^{2}\left(x\right)+f\left(x\right)}{2g_{0}\left(x\right)}\right)^{2}&\equiv f\left(x\right) &\pmod{x^{n}}\\
    \frac{g_{0}^{2}\left(x\right)+f\left(x\right)}{2g_{0}\left(x\right)}&\equiv g\left(x\right) &\pmod{x^{n}}\\
    2^{-1}g_{0}\left(x\right)+2^{-1}g_{0}^{-1}\left(x\right)f\left(x\right)&\equiv g\left(x\right) &\pmod{x^{n}}
\end{aligned}
$$

倍增计算即可。

**时间复杂度**

$$
T\left(n\right)=T\left(\frac{n}{2}\right)+O\left(n\log{n}\right)=O\left(n\log{n}\right)
$$

还有一种常数较小的写法就是在倍增维护 $g\left(x\right)$ 的时候同时维护 $g^{-1}\left(x\right)$ 而不是每次都求逆。

> 当 $\left[x^{0}\right]f\left(x\right)\neq 1$ 时，可能需要使用[二次剩余](../Number/二次剩余.md#cipolla-算法)来计算 $\left[x^{0}\right]g\left(x\right)$。

上述方法需要知道 $g_{0}(x)$ 的逆，所以常数项不能为 $0$。

若 $\left[x^0\right]f(x) = 0$，则将 $f(x)$ 分解成 $x^{k}h(x)$，其中 $\left[x^0\right]h(x) \not = 0$。

-   若 $k$ 是奇数，则 $f(x)$ 没有平方根。
-   若 $k$ 是偶数，则求出 $h(x)$ 的平方根 $\sqrt{h(x)}$，然后得到 $g(x) \equiv x^{k/2} \sqrt{h(x)} \pmod{x^{n}}$。

??? code "实现"
    === "普通版"
        ```cpp
        --8<-- "docs/Math/Poly/code/P5205.cpp:60:80"
        ```
    === "加强版"
        ```cpp
        --8<-- "docs/Math/Poly/code/P5277.cpp:95:117"
        ```

## 多项式除法 & 取模

???+ question "[P4512 【模板】多项式除法](https://www.luogu.com.cn/problem/P4512)"
    给定多项式 $F\left(x\right),G\left(x\right)$，求 $G\left(x\right) \div F\left(x\right)$ 的商式 $Q\left(x\right)$ 和余式 $R\left(x\right)$。


发现若能消除 $R\left(x\right)$ 的影响则可直接 [多项式求逆](#多项式求逆) 解决。

具体来说，设多项式 $A$ 为 $n$ 次多项式，考虑一种操作 $R$，使得

$$A_R(x) = x^n A\left(\frac{1}{x}\right)$$

稍微想象一下，可以发现 $A_R[i] = A[n - i]$（$[i]$ 表示多项式的第 $i$ 次系数）。这个操作可以 $O(n)$ 完成。

然后开始推式子：

$$\begin{aligned}
F(x) &= Q(x) * G(x) + R(x) \\
F\left(\frac{1}{x}\right) &= Q\left(\frac{1}{x}\right) * G\left(\frac{1}{x}\right) + R\left(\frac{1}{x}\right) \\
x^n F\left(\frac{1}{x}\right) &= x^{n - m} Q\left(\frac{1}{x}\right) * x^m G\left(\frac{1}{x}\right) + x^{n - m + 1} * x^{m - 1} R\left(\frac{1}{x}\right) \\
F_R(x) &= Q_R(x) * G_R(x) + x^{n - m + 1} * R_R(x) \\
F_R(x) &\equiv Q_R(x) * G_R(x) + x^{n - m + 1} * R_R(x) \pmod{x^{n-m+1}} \\
F_R(x) &\equiv Q_R(x) * G_R(x) \pmod{x^{n-m+1}} \\
Q_R(x) &\equiv F_R(x) * G_R^{-1}(x) \pmod{x^{n-m+1}}
\end{aligned}$$

求一遍 $G_R$ 的逆，然后就可以利用多项式乘法求出 $Q$。然后

$$R(x) = F(x) - G(x) * Q(x)$$

直接计算即可。时间复杂度 $O(n \log n)$。

**时间复杂度**  $O\left(n\log{n}\right)$。

??? code "实现"
    ```cpp
    --8<-- "docs/Math/Poly/code/P4512.cpp:60:77"
    ```

## 多项式对数函数

???+ question "[P4725 【模板】多项式对数函数（多项式 ln）](https://www.luogu.com.cn/problem/P4725)"
    给定多项式 $f(x)$，求模 $x^{n}$ 意义下的 $\ln{f(x)}$。

首先，对于多项式 $f(x)$，若 $\ln{f(x)}$ 存在，则由其定义，其必须满足：

$$
[x^{0}]f(x)=1
$$

对 $\ln{f(x)}$ 求导再积分，可得：

$$
\begin{aligned}
    \frac{\mathrm{d} \ln{f(x)}}{\mathrm{d} x} & \equiv \frac{f'(x)}{f(x)} & \pmod{x^{n}} \\
    \ln{f(x)} & \equiv \int\frac{f'(x)}{f(x)} \mathrm{d} x & \pmod{x^{n}}
\end{aligned}
$$

多项式的求导，积分时间复杂度为 $O(n)$，求逆时间复杂度为 $O(n\log{n})$，故多项式求 $\ln$ 时间复杂度 $O(n\log{n})$。

??? code "实现"
    ```cpp
    --8<-- "docs/Math/Poly/code/P5264.cpp:72:83"
    ```

## 多项式指数函数

???+ question "[P4726 【模板】多项式指数函数（多项式 exp）](https://www.luogu.com.cn/problem/P4726)"
    给定多项式 $f(x)$，求模 $x^{n}$ 意义下的 $\exp{f(x)}$。

首先，对于多项式 $f(x)$，若 $\exp{f(x)}$ 存在，则其必须满足：

$$
[x^{0}]f(x)=0
$$

否则 $\exp{f(x)}$ 的常数项不收敛。

对 $\exp{f(x)}$ 求导，可得：

$$
\frac{\mathrm{d} \exp{f(x)}}{\mathrm{d} x} \equiv \exp{f(x)}f'(x)\pmod{x^{n}}
$$

比较两边系数可得：

$$
[x^{n-1}]\frac{\mathrm{d} \exp{f(x)}}{\mathrm{d} x} = \sum_{i = 0}^{n - 1} \left([x^{i}]\exp{f(x)}\right) \left([x^{n-i-1}]f'(x)\right)
$$

$$
n[x^{n}]\exp{f(x)} = \sum_{i = 0}^{n - 1} \left([x^{i}]\exp{f(x)}\right) \left((n - i)[x^{n - i}]f(x)\right)
$$

使用分治 FFT 即可解决。

**时间复杂度**  $O(n\log^{2}{n})$。

更加常见且快速的做法是应用 [Newton's Method](./多项式牛顿迭代.md#多项式指数函数)，时间复杂度 $O(n\log n)$，下面是其实现：

??? code "实现"
    ```cpp
    --8<-- "docs/Math/Poly/code/P5264.cpp:84:101"
    ```

## 多项式快速幂

???+ question "[P5245 【模板】多项式快速幂](https://www.luogu.com.cn/problem/P5245) [P5273 【模板】多项式快速幂（加强版）](https://www.luogu.com.cn/problem/P5273)"
    计算 $f^{k}(x)$

普通做法为直接套用实数域中的快速幂，时间复杂度 $O(n\log{n}\log{k})$，不够优秀，Luogu上的板子中，$k = 10^{10^{15}}$。

（普通版）当 $[x^{0}]f(x)=1$ 时，有：

$$f^{k}(x)=\exp{\left(k\ln{f(x)}\right)}$$

（加强版）当 $[x^{0}]f(x)\neq 1$ 时，设 $f(x)$ 的最低次项为 $f_{i}x^{i}$，则：

$$f^{k}(x)=f_{i}^{k}x^{ik}\exp{\left(k\ln{\frac{f(x)}{f_{i}x^{i}}}\right)}$$

**时间复杂度**  $O(n\log{n})$。

??? code "实现"
    === "普通版"
        ```cpp
        --8<-- "docs/Math/Poly/code/P5245.cpp:111:134"
        ```
    === "加强版"
        ```cpp
        --8<-- "docs/Math/Poly/code/P5273.cpp:104:131"
        ```

## 多项式三角函数

???+ question "[P5264 多项式三角函数](https://www.luogu.com.cn/problem/P5264)"
    给定多项式 $f\left(x\right)$，求模 $x^{n}$ 意义下的 $\sin{f\left(x\right)}$ 与 $\cos{f\left(x\right)}$。


首先由欧拉公式 $\left(\mathrm{e}^{\mathrm{i}x} = \cos{x} + \mathrm{i}\sin{x}\right)$ 可以得到三角函数的另一个表达式

$$
\begin{aligned}
    \sin{x} &= \frac{\mathrm{e}^{\mathrm{i}x} - \mathrm{e}^{-\mathrm{i}x}}{2\mathrm{i}} \\
    \cos{x} &= \frac{\mathrm{e}^{\mathrm{i}x} + \mathrm{e}^{-\mathrm{i}x}}{2}
\end{aligned}
$$

那么代入 $f\left(x\right)$ 就有：

$$
\begin{aligned}
    \sin{f\left(x\right)} &= \frac{\exp{\left(\mathrm{i}f\left(x\right)\right)} - \exp{\left(-\mathrm{i}f\left(x\right)\right)}}{2\mathrm{i}} \\
    \cos{f\left(x\right)} &= \frac{\exp{\left(\mathrm{i}f\left(x\right)\right)} + \exp{\left(-\mathrm{i}f\left(x\right)\right)}}{2}
\end{aligned}
$$

直接按上述表达式编写程序即可得到模 $x^{n}$ 意义下的 $\sin{f\left(x\right)}$ 与 $\cos{f\left(x\right)}$。再由 $\tan{f\left(x\right)} = \frac{\sin{f\left(x\right)}}{\cos{f\left(x\right)}}$ 可求得 $\tan{f\left(x\right)}$。

???+ note "模意义下的虚数"
    注意到我们是在 $\mathbb{Z}_{998244353}$ 上做 NTT，那么相应地，虚数单位 $\mathrm{i}$ 应该被换成 $86583718$ （或 $911660635$）：

    $$
    \begin{aligned}
               & \mathrm{i} = \sqrt{-1} \equiv \sqrt{998244352} \pmod{998244353}       \\
      \implies & \phantom{\text{or}} \quad \mathrm{i} \equiv 86583718 \pmod{998244353}
    \end{aligned}
    $$

    对应 $g^{\frac{p - 1}{4}}$。

??? code "实现"
    ```cpp
    --8<-- "docs/Math/Poly/code/P5264.cpp:102:120"
    ```

## 多项式反三角函数

???+ question "[P5265 多项式反三角函数](https://www.luogu.com.cn/problem/P5265)"
    给定多项式 $f\left(x\right)$，求模 $x^{n}$ 意义下的 $\arcsin{f\left(x\right)}$ 与 $\arctan{f\left(x\right)}$。

仿照求多项式 $\ln$ 的方法，对反三角函数求导再积分可得：

$$
\begin{aligned}
    \frac{\mathrm{d}}{\mathrm{d} x} \arcsin{x} &= \frac{1}{\sqrt{1 - x^{2}}} \\
    \arcsin{x} &= \int \frac{1}{\sqrt{1 - x^{2}}} \mathrm{d} x \\
    \frac{\mathrm{d}}{\mathrm{d} x} \arccos{x} &= - \frac{1}{\sqrt{1 - x^{2}}} \\
    \arccos{x} &= - \int \frac{1}{\sqrt{1 - x^{2}}} \mathrm{d} x \\
    \frac{\mathrm{d}}{\mathrm{d} x} \arctan{x} &= \frac{1}{1 + x^{2}} \\
    \arctan{x} &= \int \frac{1}{1 + x^{2}} \mathrm{d} x
\end{aligned}
$$

那么代入 $f\left(x\right)$ 就有：

$$
\begin{aligned}
    \frac{\mathrm{d}}{\mathrm{d} x} \arcsin{f\left(x\right)} &= \frac{f'\left(x\right)}{\sqrt{1 - f^{2}\left(x\right)}} \\
    \arcsin{f\left(x\right)} &= \int \frac{f'\left(x\right)}{\sqrt{1 - f^{2}\left(x\right)}} \mathrm{d} x \\
    \frac{\mathrm{d}}{\mathrm{d} x} \arccos{f\left(x\right)} &= - \frac{f'\left(x\right)}{\sqrt{1 - f^{2}\left(x\right)}} \\
    \arccos{f\left(x\right)} &= - \int \frac{f'\left(x\right)}{\sqrt{1 - f^{2}\left(x\right)}} \mathrm{d} x \\
    \frac{\mathrm{d}}{\mathrm{d} x} \arctan{f\left(x\right)} &= \frac{f'\left(x\right)}{1 + f^{2}\left(x\right)} \\
    \arctan{f\left(x\right)} &= \int \frac{f'\left(x\right)}{1 + f^{2}\left(x\right)} \mathrm{d} x
\end{aligned}
$$

直接按式子求就可以了。~~（我也不清楚Luogu凭什么给这个玩意评黑）~~

??? code "实现"
    ```cpp
    --8<-- "docs/Math/Poly/code/P5265.cpp:92:131"
    ```

## 总结

下面的代码实现了 `Poly` 类，实现了本页面的所有操作，但常数很大。

??? code "实现"
    ```cpp
    --8<-- "docs/Math/Poly/code/Poly.cpp"
    ```