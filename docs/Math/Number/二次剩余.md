> 本文转载（或修改）自 [OI-Wiki](https://oi-wiki.org/math/number-theory/quad-residue/)

## 定义

令整数 $a$，$p$ 满足 $a \bot p$，若存在整数 $x$ 使得

$$
x^2\equiv a\pmod p
$$

则称 $a$ 为模 $p$ 的二次剩余，否则称 $a$ 为模 $p$ 的二次非剩余。

通俗一些，可以认为是求模意义下的 **开平方** 运算。对于更高次方的开方可参见 $k$ 次剩余。

这里只讨论 $p$ 为 **奇素数** 的求解方法。后文可能在模 $p$ 显然的情况下简写成二次（非）剩余。

## Euler 判别法

对奇素数 $p$ 和满足 $a \bot p$ 的整数 $a$，

$$
a^{\frac{p-1}{2}}\equiv\begin{cases}
    1 \pmod p,  & (\exists x\in\mathbf{Z}),~~a\equiv x^2\pmod p,\\
    -1 \pmod p, & \text{otherwise}.\\
\end{cases}
$$

即对上述的 $p$ 和 $a$，

1.  $a$ 是 $p$ 的二次剩余当且仅当 $a^{\frac{p-1}{2}}\equiv 1 \pmod p$.
2.  $a$ 是 $p$ 的二次非剩余当且仅当 $a^{\frac{p-1}{2}}\equiv -1 \pmod p$.

???+ tip "证明"
    首先由 Fermat 小定理，有 $a^{p-1}\equiv 1\pmod p$，故

    $$
    \left(a^{\frac{p-1}{2}}+1\right)\left(a^{\frac{p-1}{2}}-1\right)\equiv 0\pmod p
    $$

    从而对任意满足 $a \bot p$ 的 $a$ 均有 $a^{(p-1)/2}\equiv \pm 1\pmod p$

    另外由 $p$ 是奇素数，我们有：

    $$
    x^{p-1}-a^{\frac{p-1}{2}}={\left(x^2\right)}^{\frac{p-1}{2}}-a^{\frac{p-1}{2}}=(x^2-a)P(x)
    $$

    其中 $P(x)$ 是某个整系数多项式，进而：

    $$
    \begin{aligned}
        x^p-x&=x\left(x^{p-1}-a^{\frac{p-1}{2}}\right)+x\left(a^{\frac{p-1}{2}}-1\right)\\
        &=(x^2-a)xP(x)+\left(a^{\frac{p-1}{2}}-1\right)x\\
    \end{aligned}
    $$

    因此，$a$ 是模 $p$ 的二次剩余当且仅当 $a^{(p-1)/2}\equiv 1\pmod p$. 进而 $a$ 是模 $p$ 的非二次剩余当且仅当 $a^{(p-1)/2}\equiv -1\pmod p$.

## Legendre 符号

???+ note "定义"
    对奇素数 $p$ 和整数 $a$，定义 Legendre 符号如下：

    $$
    \left(\frac{a}{p}\right)=\begin{cases}
        0,  & p\mid a,\\
        1,  & (p\nmid a) \land ((\exists x\in\mathbf{Z}),~~a\equiv x^2\pmod p),\\
        -1, & \text{otherwise}.\\
    \end{cases}
    $$

### 性质

???+ "性质一"
    对任意整数 $a$，

    $$
    a^{\frac{p-1}{2}}\equiv \left(\frac{a}{p}\right)\pmod p
    $$

    进一步，我们有推论：

    $$
    \left(\frac{1}{p}\right)=1
    $$

    以及

    $$
    \begin{aligned}
        \left(\frac{-1}{p}\right)&=(-1)^{\frac{p-1}{2}}\\
        &=\begin{cases}
            1,  & p\equiv 1\pmod 4,\\
            -1, & p\equiv 3\pmod 4.
            \end{cases}
    \end{aligned}
    $$

    ???+ tip "证明"
        由 [Legendre 符号的定义](#legendre-符号) 和 [Euler 判别法](#euler-判别法) 易得。

???+ "性质二"
    $a_1\equiv a_2\pmod p\implies \left(\frac{a_1}{p}\right)=\left(\frac{a_2}{p}\right)$

    ???+ tip "证明"
        注意到

        $$
        a_1\equiv a_2\pmod p\implies \left(\frac{a_1}{p}\right)\equiv\left(\frac{a_2}{p}\right)\pmod p
        $$

        而 $\left|\left(\frac{a_1}{p}\right)-\left(\frac{a_2}{p}\right)\right|\leq 2$ 且 $p>2$, 故：

        $$
        a_1\equiv a_2\pmod p\implies \left(\frac{a_1}{p}\right)=\left(\frac{a_2}{p}\right)
        $$

???+ "性质三（[完全积性](./Mulfunc/积性函数.md#完全积性函数)）"
    对任意整数 $a_1,a_2$，

    $$
    \left(\frac{a_1a_2}{p}\right)=\left(\frac{a_1}{p}\right)\left(\frac{a_2}{p}\right)
    $$

    我们有推论：对整数 $a,b$，$p\nmid b$ 有

    $$
    \left(\frac{ab^2}{p}\right)=\left(\frac{a}{p}\right)
    $$

    ???+ tip "证明"
        由 1 得

        $$
        \left(\frac{a_1a_2}{p}\right)\equiv a_1^{\frac{p-1}{2}}a_2^{\frac{p-1}{2}}\equiv\left(\frac{a_1}{p}\right)\left(\frac{a_2}{p}\right)\pmod p
        $$

        而 $\left|\left(\frac{a_1a_2}{p}\right)-\left(\frac{a_1}{p}\right)\left(\frac{a_2}{p}\right)\right|\leq 2$ 且 $p>2$, 故：

        $$
        \left(\frac{a_1a_2}{p}\right)=\left(\frac{a_1}{p}\right)\left(\frac{a_2}{p}\right)
        $$

???+ "性质四"
    $$
    \begin{aligned}
        \left(\frac{2}{p}\right)&=(-1)^{\frac{p^2-1}{8}}\\
        &=\begin{cases}
                1,  & p\equiv \pm 1\pmod 8 \\
                -1, & p\equiv \pm 3\pmod 8 \\
            \end{cases}
    \end{aligned}
    $$

    ???+ tip "证明"
        参见 [二次互反律](#二次互反律)

### 二次互反律

???+ note "二次互反律"
    设 $p$，$q$ 是两个不同的奇素数，则

    $$
    \left(\frac{p}{q}\right)\left(\frac{q}{p}\right)=(-1)^{\frac{p-1}{2}\frac{q-1}{2}}
    $$

证明方式很多，一种证明方式是基于如下引理（Gauss 引理）：

???+ note "Gauss 引理"
    设 $(n,p)=1$, 对整数 $k~\left(1\leq k\leq \frac{p-1}{2}\right)$，令 $r_k$ 为 $nk$ 模 $p$ 的最小非负剩余，设 $m$ 为所有 $r_k$ 中大于 $\frac{p}{2}$ 的个数，则

    $$
    \left(\frac{n}{p}\right)=(-1)^m
    $$

这个引理可以证明如下有用的结论：

???+ note "结论"
    对奇素数 $p$，

    $$
    \begin{aligned}
        \left(\frac{2}{p}\right)&=(-1)^{\frac{p^2-1}{8}}\\
        &=\begin{cases}
                1,  & p\equiv \pm 1\pmod 8 \\
                -1, & p\equiv \pm 3\pmod 8 \\
            \end{cases}
    \end{aligned}
    $$

二次互反律不仅能用于判断数 $n$ 是否是模 $p$ 的二次剩余，还能用于确定使数 $n$ 为二次剩余的模数的结构。

## 二次剩余的数量

对于奇素数 $p$，模 $p$ 意义下二次剩余和二次非剩余均有 $\frac{p-1}{2}$ 个。

???+ note "证明"
    根据 Euler 判别法，考虑 $a^{\frac{p-1}{2}}\equiv 1\pmod p$.

    注意到 $\frac{p-1}{2}\mid (p-1)$，这可知 $a^{\frac{p-1}{2}}\equiv 1\pmod p$ 有 $\frac{p-1}{2}$ 个解。所以模 $p$ 意义下二次剩余和二次非剩余均有 $\frac{p-1}{2}$ 个。

### Cipolla 算法

???+ question "[P5491 【模板】二次剩余](https://www.luogu.com.cn/problem/P5491)"
    给出 $N,p$，求解方程

    $$
    x^2 \equiv N \pmod{p}
    $$

    多组数据，**且保证 $p$ 是奇素数。**

    对于 $100\%$ 的数据，$1\leq T\leq 10^4,0\le N, p\leq 10^9+9$。

这里介绍用爆搜 $p$ 为奇素数的做法，也就是 Cipolla 算法。

对于二次剩余解方程 $x^2 = n$。找到一个 $w$ 满足 $w^2 - n$ 是非二次剩余（由于二次剩余的数量是 $\frac{p - 1}{2}$，通过随机检验的方式期望 $2$ 次可以找到这样一个 $w$）。接下来定义 $i^2 = w^2 - n$（$i^2$ 不是二次剩余）。类似实数域复数域的定义，定义 $i$，所有数可表示为 $A + Bi$ 的形式（$A, B$ 是模 $p$ 意义下的数，类似实部和虚部）。

???+ note "引理 1"

    $$i^p \equiv -i$$

    ???+ tip "证明"
        $$i^p = i(i^2)^{\frac{p - 1}{2}} \equiv i(w^2 - n)^{\frac{p - 1}{2}} \equiv -i$$

???+ note "引理 2"

    $$(A + B)^p \equiv A^p + B^p$$

    ???+ tip "证明"
        二项式定理展开，由于 $p$ 是素数，除 $C_p^0, C_p^p$ 外的组合数分子上的阶乘无法消去，模 $p$ 都会为 $0$，剩下 $C_p^0 A^p B^0 + C_p^p A^0 B^p$。

利用上述结论：

$$ (a + i)^p = (a^p + i^p)(a + i) = (a - i)(a + i) = a^2 - i^2 = n$$

那么 $(a + i)^{\frac{p + 1}{2}}$ 是一个解，其相反数是另一个解。

验证 $(a + i)^{\frac{p + 1}{2}}$ 的虚部一定为 $0$：假设存在 $(A + Bi)^{\frac{p + 1}{2}} \equiv n$ 且 $B \neq 0$，则 $(A + Bi)^p = A - Bi$，乘上 $(A + Bi)$ 得 $A^2 + B^2 = n$，$-2ABi = 0$。式子左边虚部为 $0$，则 $AB = 0$。

若 $B \neq 0$，则 $A = 0$，即 $(Bi)^2 \equiv n$，但 $i^2$ 不是二次剩余，矛盾。

故 $B = 0$，$(A + Bi)^{\frac{p + 1}{2}}$ 是二次剩余，乘上二次剩余 $n$ 后仍为二次剩余，不会产生矛盾。

??? code "实现"
    ```cpp
    --8<-- "docs/Math/Number/code/P5491.cpp"
    ```